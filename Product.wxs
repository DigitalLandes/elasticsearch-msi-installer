<?xml version="1.0" encoding="UTF-8"?>
<!-- DO NOT EDIT THIS FILE 

Copyright 2014-2015 Hendrik Saly
Licensed under the Apache License, Version 2.0

-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="2b07b100-a66a-4280-839d-229ce63a9318" Name="Elasticsearch Windows Service" Language="1033" Version="$(var.EsiVersion)" Manufacturer="Installer by Hendrik Saly" UpgradeCode="4487b100-a66a-4280-839d-d29ce63a931d">
    <Package InstallerVersion="400" Compressed="yes" InstallScope="perMachine" Platform="x64" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." Schedule="afterInstallInitialize"/>

    <!-- 
      http://msdn.microsoft.com/en-us/library/aa372380%28v=vs.85%29.aspx
      http://code.dblock.org/msi-property-patterns-upgrading-firstinstall-and-maintenance
      http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg42579.html
    -->
    <SetProperty After="FindRelatedProducts" Id="FirstInstall" Value="true">
      NOT Installed AND NOT WIX_UPGRADE_DETECTED AND NOT WIX_DOWNGRADE_DETECTED
    </SetProperty>
    <SetProperty After="SetFirstInstall" Id="Upgrading" Value="true">
      WIX_UPGRADE_DETECTED AND NOT (REMOVE="ALL")
    </SetProperty>
    <SetProperty After ="RemoveExistingProducts" Id="RemovingForUpgrade" Sequence="execute" Value="true">
      (REMOVE="ALL") AND UPGRADINGPRODUCTCODE
    </SetProperty>
    <SetProperty After="SetUpgrading" Id="Uninstalling" Value="true">
      Installed AND (REMOVE="ALL") AND NOT (WIX_UPGRADE_DETECTED OR UPGRADINGPRODUCTCODE)
    </SetProperty>
    <SetProperty After="SetUninstalling" Id="Maintenance" Value="true">
      Installed AND NOT Upgrading AND NOT Uninstalling AND NOT UPGRADINGPRODUCTCODE
    </SetProperty>

    <Media Id="1" Cabinet="Cab1.cab" EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="ESI" Level="1">
      <ComponentGroupRef Id="MyFiles" />
    </Feature>


    <Condition Message="This application is only supported on 64bit Windows (Win7/2008 or higher).">
      <![CDATA[Installed OR (VersionNT64 >= 601)]]>
    </Condition>


    <CustomAction Id="BatchCmd" ExeCommand="[INSTALLDIR]$(var.EsFolder)\bin\esi_service.bat" Directory="INSTALLDIR" Execute="deferred" Return="check" Impersonate="no"/>
    <CustomAction Id="BatchCmdU" ExeCommand="[INSTALLDIR]$(var.EsFolder)\bin\esi_service_uninstall.bat" Directory="INSTALLDIR" Execute="deferred" Return="ignore" Impersonate="no"/>

    <InstallExecuteSequence>      
      <Custom Action="BatchCmd" After="InstallFiles" >FirstInstall</Custom>
      <Custom Action="BatchCmdU" Before="RemoveFiles">Uninstalling</Custom>    
    </InstallExecuteSequence>

  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLDIR" Name="Elasticsearch" />
      </Directory>
    </Directory>
  </Fragment>


</Wix>
